# CD pipeline 
# triggered when a PR is merged to main branch
# 
# Gets new repository version for tagging purposes
#
# Tags git repository with new version number
# 
# Builds docker image tagged with version number
# Pushes image to ECR 

# TODO: once ArgoCD+Kustomize are set up, add workflow to update Kustomize file with new image

name: cd
on:
  push:
    branches:
      - 'main'
    paths:
      - 'test_change_file.yaml'
      - 'update_image_in_kustomize.yml'
  pull_request:
    types:
      - closed
    branches:
      - 'main'
    paths-ignore:
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        default: 'latest'

jobs:
  output_an_image_name:
    uses: ./.github/workflows/output_an_image_name.yml
    with:
      version: ${{ inputs.version }}
  update_kustomize_image:
    needs: output_an_image_name
    uses: ./.github/workflows/update_image_in_kustomize.yml
    with:
      tagged_image: ${{ needs.output_an_image_name.outputs.tagged_image }}
      deployment_yaml_path: "test_change_file.yaml"
    secrets: inherit